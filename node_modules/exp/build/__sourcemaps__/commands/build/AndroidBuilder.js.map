{"version":3,"sources":["commands/build/AndroidBuilder.js"],"names":["AndroidBuilder","options","buildOptions","publicUrl","checkStatus","platform","validateProject","collectAndValidateCredentials","undefined","ensureReleaseExists","publishedExpIds","build","getThirdPartyInfoAsync","getPublishInfoAsync","projectDir","args","username","remotePackageName","experienceName","remoteFullPackageName","credentialMetadata","warn","red","questions","type","name","message","answers","confirm","backupKeystoreOutputPath","resolve","backupExistingAndroidCredentials","outputPath","log","removeCredentialsForPlatform","credentialsExistForPlatformAsync","credentialsExist","checkEnv","collectAndValidateCredentialsFromCI","clearCredentials","console","choices","value","validate","keystorePath","stat","keystorePathStats","isFile","filter","isAbsolute","when","uploadKeystore","val","password","_clearCredentials","keystoreAlias","keystorePassword","keyPassword","readFile","keystoreData","credentials","keystore","toString","updateCredentialsForPlatform","process","env","EXPO_ANDROID_KEYSTORE_PASSWORD","EXPO_ANDROID_KEY_PASSWORD","sdkVersion","checkIfSdkIsSupported"],"mappings":"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","file":"../../../commands/build/AndroidBuilder.js","sourcesContent":["/**\n * @flow\n */\n\nimport fs from 'fs-extra';\nimport path from 'path';\nimport untildify from 'untildify';\nimport { Exp, Credentials } from 'xdl';\nimport chalk from 'chalk';\nimport log from '../../log';\n\nimport BaseBuilder from './BaseBuilder';\nimport prompt from '../../prompt';\n\nexport default class AndroidBuilder extends BaseBuilder {\n  async run(options) {\n    const buildOptions = options.publicUrl ? { publicUrl: options.publicUrl } : {};\n    // Check the status of any current builds\n    await this.checkStatus({ platform: 'android', ...buildOptions });\n    // Validate project\n    await this.validateProject(buildOptions);\n    // Check for existing credentials, collect any missing credentials, and validate them\n    await this.collectAndValidateCredentials(buildOptions);\n    // Publish the current experience, if necessary\n    let publishedExpIds = options.publicUrl ? undefined : await this.ensureReleaseExists('android');\n\n    // Initiate a build\n    await this.build(publishedExpIds, 'android', buildOptions);\n  }\n\n  async _clearCredentials(options = {}) {\n    const publicUrl = options.publicUrl;\n    const {\n      args: { username, remotePackageName, remoteFullPackageName: experienceName },\n    } = publicUrl\n      ? await Exp.getThirdPartyInfoAsync(publicUrl)\n      : await Exp.getPublishInfoAsync(this.projectDir);\n\n    const credentialMetadata = {\n      username,\n      experienceName,\n      platform: 'android',\n    };\n\n    log.warn(\n      `Clearing your Android build credentials from our build servers is a ${chalk.red(\n        'PERMANENT and IRREVERSIBLE action.'\n      )}`\n    );\n    log.warn(\n      'Android keystores must be identical to the one previously used to submit your app to the Google Play Store.'\n    );\n    log.warn(\n      'Please read https://docs.expo.io/versions/latest/guides/building-standalone-apps.html#if-you-choose-to-build-for-android for more info before proceeding.'\n    );\n    log.warn(\n      \"We'll store a backup of your Android keystore in this directory in case you decide to delete it from our servers.\"\n    );\n    let questions = [\n      {\n        type: 'confirm',\n        name: 'confirm',\n        message: 'Permanently delete the Android build credentials from our servers?',\n      },\n    ];\n\n    const answers = await prompt(questions);\n\n    if (answers.confirm) {\n      log('Backing up your Android keystore now...');\n      const backupKeystoreOutputPath = path.resolve(\n        this.projectDir,\n        `${remotePackageName}.jks.bak`\n      );\n      await Credentials.backupExistingAndroidCredentials({\n        outputPath: backupKeystoreOutputPath,\n        username,\n        experienceName,\n        log,\n      });\n      await Credentials.removeCredentialsForPlatform('android', credentialMetadata);\n      log.warn('Removed existing credentials from Expo servers');\n    }\n  }\n\n  async collectAndValidateCredentials(options = {}) {\n    const publicUrl = options.publicUrl;\n    const { args: { username, remoteFullPackageName: experienceName } } = publicUrl\n      ? await Exp.getThirdPartyInfoAsync(publicUrl)\n      : await Exp.getPublishInfoAsync(this.projectDir);\n\n    const credentialMetadata = {\n      username,\n      experienceName,\n      platform: 'android',\n    };\n\n    const credentialsExist = await Credentials.credentialsExistForPlatformAsync(credentialMetadata);\n\n    if (this.checkEnv()) {\n      await this.collectAndValidateCredentialsFromCI(credentialMetadata);\n    } else if (this.options.clearCredentials || !credentialsExist) {\n      console.log('');\n      const questions = [\n        {\n          type: 'rawlist',\n          name: 'uploadKeystore',\n          message: `Would you like to upload a keystore or have us generate one for you?\\nIf you don't know what this means, let us handle it! :)\\n`,\n          choices: [\n            { name: 'Let Expo handle the process!', value: false },\n            { name: 'I want to upload my own keystore!', value: true },\n          ],\n        },\n        {\n          type: 'input',\n          name: 'keystorePath',\n          message: `Path to keystore:`,\n          validate: async keystorePath => {\n            try {\n              const keystorePathStats = await fs.stat(keystorePath);\n              return keystorePathStats.isFile();\n            } catch (e) {\n              // file does not exist\n              console.log('\\nFile does not exist.');\n              return false;\n            }\n          },\n          filter: keystorePath => {\n            keystorePath = untildify(keystorePath);\n            if (!path.isAbsolute(keystorePath)) {\n              keystorePath = path.resolve(keystorePath);\n            }\n            return keystorePath;\n          },\n          when: answers => answers.uploadKeystore,\n        },\n        {\n          type: 'input',\n          name: 'keystoreAlias',\n          message: `Keystore Alias:`,\n          validate: val => val !== '',\n          when: answers => answers.uploadKeystore,\n        },\n        {\n          type: 'password',\n          name: 'keystorePassword',\n          message: `Keystore Password:`,\n          validate: val => val !== '',\n          when: answers => answers.uploadKeystore,\n        },\n        {\n          type: 'password',\n          name: 'keyPassword',\n          message: `Key Password:`,\n          validate: (password, answers) => {\n            if (password === '') {\n              return false;\n            }\n            // Todo validate keystore passwords\n            return true;\n          },\n          when: answers => answers.uploadKeystore,\n        },\n      ];\n\n      const answers = await prompt(questions);\n\n      if (!answers.uploadKeystore) {\n        if (this.options.clearCredentials && credentialsExist) {\n          await this._clearCredentials(options);\n        }\n        // just continue\n      } else {\n        const { keystorePath, keystoreAlias, keystorePassword, keyPassword } = answers;\n\n        // read the keystore\n        const keystoreData = await fs.readFile(keystorePath);\n\n        const credentials = {\n          keystore: keystoreData.toString('base64'),\n          keystoreAlias,\n          keystorePassword,\n          keyPassword,\n        };\n        await Credentials.updateCredentialsForPlatform('android', credentials, credentialMetadata);\n      }\n    }\n  }\n\n  checkEnv() {\n    return (\n      this.options.keystorePath &&\n      this.options.keystoreAlias &&\n      process.env.EXPO_ANDROID_KEYSTORE_PASSWORD &&\n      process.env.EXPO_ANDROID_KEY_PASSWORD\n    );\n  }\n\n  async collectAndValidateCredentialsFromCI(credentialMetadata) {\n    const credentials = {\n      keystore: (await fs.readFile(this.options.keystorePath)).toString('base64'),\n      keystoreAlias: this.options.keystoreAlias,\n      keystorePassword: process.env.EXPO_ANDROID_KEYSTORE_PASSWORD,\n      keyPassword: process.env.EXPO_ANDROID_KEY_PASSWORD,\n    };\n    await Credentials.updateCredentialsForPlatform('android', credentials, credentialMetadata);\n  }\n\n  async validateProject(options) {\n    const publicUrl = options.publicUrl;\n    const { args: { sdkVersion } } = publicUrl\n      ? await Exp.getThirdPartyInfoAsync(publicUrl)\n      : await Exp.getPublishInfoAsync(this.projectDir);\n    await this.checkIfSdkIsSupported(sdkVersion, 'android');\n  }\n}\n"],"sourceRoot":"/exp@57.2.1/src"}