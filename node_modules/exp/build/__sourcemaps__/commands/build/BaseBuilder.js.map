{"version":3,"sources":["commands/build/BaseBuilder.js"],"names":["sleep","setTimeout","res","ms","secondsToMilliseconds","seconds","BaseBuilder","projectDir","options","wait","clearCredentials","releaseChannel","publish","_checkProjectConfig","run","error","message","process","exit","readConfigJsonAsync","exp","isDetached","platform","current","publicUrl","buildAsync","mode","buildStatus","err","Error","jobs","length","raw","forEach","job","i","packageExtension","constructBuildLogsUrl","id","status","underline","constructTurtleStatusUrl","artifacts","url","hardcodeRevisionId","ids","getLatestReleaseAsync","release","channel","publicationId","publishedTime","buildId","timeout","interval","time","Date","getTime","endTime","compose","head","filter","getOr","expIds","extraArgs","opts","type","bundleIdentifier","start","waitOpts","completedJob","stop","artifactUrl","artifactId","constructArtifactUrl","green","sdkVersion","canTurtleBuildSdkVersion","isSupported","storeName","red","getExpoDomainUrl","env","EXPO_STAGING","EXPO_LOCAL"],"mappings":"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","file":"../../../commands/build/BaseBuilder.js","sourcesContent":["/**\n * @flow\n */\n\nimport { Project, ProjectUtils, Versions } from 'xdl';\nimport chalk from 'chalk';\nimport fp from 'lodash/fp';\nimport simpleSpinner from '@expo/simple-spinner';\n\nimport log from '../../log';\nimport { action as publishAction } from '../publish';\nimport BuildError from './BuildError';\n\nconst sleep = ms => new Promise(res => setTimeout(res, ms));\nconst secondsToMilliseconds = seconds => seconds * 1000;\n\ntype BuilderOptions = {\n  wait: boolean,\n  clearCredentials: boolean,\n  type?: string,\n  releaseChannel: string,\n  publish: boolean,\n  teamId?: string,\n  distP12Path?: string,\n  pushP12Path?: string,\n  provisioningProfilePath?: string,\n};\n\nexport default class BaseBuilder {\n  projectDir: string = '';\n  options: BuilderOptions = {\n    wait: true,\n    clearCredentials: false,\n    releaseChannel: 'default',\n    publish: false,\n  };\n  run: () => Promise<void>;\n\n  constructor(projectDir: string, options: BuilderOptions) {\n    this.projectDir = projectDir;\n    this.options = options;\n  }\n\n  async command(options) {\n    try {\n      await this._checkProjectConfig();\n      await this.run(options);\n    } catch (e) {\n      if (!(e instanceof BuildError)) {\n        throw e;\n      } else {\n        log.error(e.message);\n        process.exit(1);\n      }\n    }\n  }\n\n  async _checkProjectConfig(): Promise<void> {\n    let { exp } = await ProjectUtils.readConfigJsonAsync(this.projectDir);\n    if (exp.isDetached) {\n      log.error(`\\`exp build\\` is not supported for detached projects.`);\n      process.exit(1);\n    }\n  }\n\n  async checkStatus(\n    {\n      platform = 'all',\n      current = true,\n      publicUrl,\n    }: { platform: string, current: boolean, publicUrl?: string } = {}\n  ): Promise<void> {\n    await this._checkProjectConfig();\n\n    log('Checking if current build exists...\\n');\n\n    const buildStatus = await Project.buildAsync(this.projectDir, {\n      mode: 'status',\n      platform,\n      current,\n      ...(publicUrl ? { publicUrl } : {}),\n    });\n\n    if (buildStatus.err) {\n      throw new Error('Error getting current build status for this project.');\n    }\n\n    if (!(buildStatus.jobs && buildStatus.jobs.length)) {\n      log('No currently active or previous builds for this project.');\n      return;\n    }\n\n    log.raw();\n    log('=================');\n    log(' Builds Statuses ');\n    log('=================\\n');\n    buildStatus.jobs.forEach((job, i) => {\n      let platform, packageExtension;\n      if (job.platform === 'ios') {\n        platform = 'iOS';\n        packageExtension = 'IPA';\n      } else {\n        platform = 'Android';\n        packageExtension = 'APK';\n      }\n\n      log(`### ${i} | ${platform} | ${constructBuildLogsUrl(job.id)} ###`);\n\n      let status;\n      switch (job.status) {\n        case 'pending':\n        case 'sent-to-queue':\n          status = `Build waiting in queue...\nYou can check the queue length at ${chalk.underline(constructTurtleStatusUrl())}`;\n          break;\n        case 'started':\n          status = 'Build started...';\n          break;\n        case 'in-progress':\n          status = 'Build in progress...';\n          break;\n        case 'finished':\n          status = 'Build finished.';\n          break;\n        case 'errored':\n          status = 'There was an error with this build.';\n          if (buildStatus.id) {\n            status += `\n\nWhen requesting support, please provide this build ID:\n\n${buildStatus.id}\n`;\n          }\n          break;\n        default:\n          status = '';\n          break;\n      }\n\n      log(status);\n      if (job.status === 'finished') {\n        if (job.artifacts) {\n          log(`${packageExtension}: ${job.artifacts.url}`);\n        } else {\n          log(`Problem getting ${packageExtension} URL. Please try to build again.`);\n        }\n      }\n      log();\n    });\n\n    throw new BuildError('Cannot start new build, as there is a build in progress.');\n  }\n\n  async ensureReleaseExists(platform: string) {\n    if (this.options.hardcodeRevisionId) {\n      // Used for sandbox build\n      return [this.options.hardcodeRevisionId];\n    }\n\n    if (this.options.publish) {\n      const { ids, url, err } = await publishAction(this.projectDir, {\n        ...this.options,\n        platform,\n      });\n      if (err) {\n        throw new BuildError(`No url was returned from publish. Please try again.\\n${err}`);\n      } else if (!url || url === '') {\n        throw new BuildError('No url was returned from publish. Please try again.');\n      }\n      return ids;\n    } else {\n      log('Looking for releases...');\n      const release = await Project.getLatestReleaseAsync(this.projectDir, {\n        releaseChannel: this.options.releaseChannel,\n        platform,\n      });\n      if (!release) {\n        throw new BuildError('No releases found. Please create one using `exp publish` first.');\n      }\n      log(\n        `Using existing release on channel \"${release.channel}\":\\n  publicationId: ${release.publicationId}\\n  publishedTime: ${release.publishedTime}`\n      );\n      return [release.publicationId];\n    }\n  }\n\n  async wait(buildId, { timeout = 1200, interval = 60, publicUrl } = {}) {\n    let time = new Date().getTime();\n    log(`Waiting for build to complete. You can press Ctrl+C to exit.`);\n    await sleep(secondsToMilliseconds(interval));\n    const endTime = time + secondsToMilliseconds(timeout);\n    while (time <= endTime) {\n      const res = await Project.buildAsync(this.projectDir, {\n        current: false,\n        mode: 'status',\n        ...(publicUrl ? { publicUrl } : {}),\n      });\n      const job = fp.compose(\n        fp.head,\n        fp.filter(job => buildId && job.id === buildId),\n        fp.getOr([], 'jobs')\n      )(res);\n      switch (job.status) {\n        case 'finished':\n          return job;\n        case 'pending':\n        case 'sent-to-queue':\n        case 'started':\n        case 'in-progress':\n          break;\n        case 'errored':\n          throw new BuildError(`Standalone build failed!`);\n        default:\n          throw new BuildError(`Unknown status: ${job.status} - aborting!`);\n      }\n      time = new Date().getTime();\n      await sleep(secondsToMilliseconds(interval));\n    }\n    throw new BuildError(\n      'Timeout reached! Project is taking longer than expected to finish building, aborting wait...'\n    );\n  }\n\n  async build(\n    expIds: Array<string>,\n    platform: string,\n    extraArgs: { publicUrl?: string, bundleIdentifier?: string } = {}\n  ) {\n    log('Building...');\n\n    let opts = {\n      mode: 'create',\n      expIds,\n      platform,\n      releaseChannel: this.options.releaseChannel,\n      ...(extraArgs.publicUrl ? { publicUrl: extraArgs.publicUrl } : {}),\n    };\n\n    if (platform === 'ios') {\n      opts = {\n        ...opts,\n        type: this.options.type,\n        bundleIdentifier: extraArgs.bundleIdentifier,\n      };\n    }\n\n    // call out to build api here with url\n    const { id: buildId } = await Project.buildAsync(this.projectDir, opts);\n\n    log('Build started, it may take a few minutes to complete.');\n\n    if (buildId) {\n      log(`You can check the queue length at\\n ${chalk.underline(constructTurtleStatusUrl())}\\n`);\n    }\n\n    if (buildId) {\n      log(`You can monitor the build at\\n\\n ${chalk.underline(constructBuildLogsUrl(buildId))}\\n`);\n    }\n\n    if (this.options.wait) {\n      simpleSpinner.start();\n      const waitOpts = extraArgs.publicUrl ? { publicUrl: extraArgs.publicUrl } : {};\n      const completedJob = await this.wait(buildId, waitOpts);\n      simpleSpinner.stop();\n      const artifactUrl = completedJob.artifactId\n        ? constructArtifactUrl(completedJob.artifactId)\n        : completedJob.artifacts.url;\n      log(`${chalk.green('Successfully built standalone app:')} ${chalk.underline(artifactUrl)}`);\n    } else {\n      log('Alternatively, run `exp build:status` to monitor it from the command line.');\n    }\n  }\n\n  async checkIfSdkIsSupported(sdkVersion: string, platform: string) {\n    const isSupported = await Versions.canTurtleBuildSdkVersion(sdkVersion, platform);\n    if (!isSupported) {\n      const storeName = platform === 'ios' ? 'Apple App Store' : 'Google Play Store';\n      log.error(\n        chalk.red(\n          `Unsupported SDK version: our app builders don't have support for ${sdkVersion} version yet. Submitting the app to the ${storeName} may result in an unexpected behaviour`\n        )\n      );\n    }\n  }\n}\n\nfunction constructBuildLogsUrl(buildId: string): string {\n  return `${getExpoDomainUrl()}/builds/${buildId}`;\n}\n\nfunction constructTurtleStatusUrl(): string {\n  return `${getExpoDomainUrl()}/turtle-status`;\n}\n\nfunction constructArtifactUrl(artifactId: string): string {\n  return `${getExpoDomainUrl()}/artifacts/${artifactId}`;\n}\n\nfunction getExpoDomainUrl() {\n  if (process.env.EXPO_STAGING) {\n    return `https://staging.expo.io`;\n  } else if (process.env.EXPO_LOCAL) {\n    return `http://expo.test`;\n  } else {\n    return `https://expo.io`;\n  }\n}\n"],"sourceRoot":"/exp@57.2.1/src"}